services:
  dask-scheduler:
    image: techstack/dask:py313
    container_name: techstack-dask-scheduler
    hostname: dask-scheduler
    command: dask-scheduler --port 8786
    ports:
      - "8786:8786"
      - "8787:8787"
    environment:
      DASK_SCHEDULER__TASKS__LOG_LENGTH: 100000
      DASK_SCHEDULER__ALLOWED_FAILURES: 5
      DASK_SCHEDULER__BANDWIDTH: 100000000
    networks:
      - techstack-network
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; socket.create_connection(('localhost', 8786), timeout=1)"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  dask-worker-1:
    image: techstack/dask:py313
    container_name: techstack-dask-worker-1
    hostname: dask-worker-1
    command: >
      dask-worker tcp://dask-scheduler:8786
      --nworkers 1
      --nthreads 4
      --memory-limit 2GB
      --worker-port 8788
      --nanny-port 8789
    environment:
      DASK_WORKER__MEMORY__TARGET: 0.85
      DASK_WORKER__MEMORY__SPILL: 0.9
      DASK_WORKER__MEMORY__PAUSE: 0.95
    depends_on:
      dask-scheduler:
        condition: service_healthy
    networks:
      - techstack-network

  dask-worker-2:
    image: techstack/dask:py313
    container_name: techstack-dask-worker-2
    hostname: dask-worker-2
    command: >
      dask-worker tcp://dask-scheduler:8786
      --nworkers 1
      --nthreads 4
      --memory-limit 2GB
      --worker-port 8790
      --nanny-port 8791
    environment:
      DASK_WORKER__MEMORY__TARGET: 0.85
      DASK_WORKER__MEMORY__SPILL: 0.9
      DASK_WORKER__MEMORY__PAUSE: 0.95
    depends_on:
      dask-scheduler:
        condition: service_healthy
    networks:
      - techstack-network

networks:
  techstack-network:
    external: true